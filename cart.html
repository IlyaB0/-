<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Цветничок у Оли | Корзина</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .cart-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .cart-header {
            margin-bottom: 40px;
            text-align: center;
        }
        
        .cart-header h1 {
            color: var(--dark-red);
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-family: 'Brush Script MT', cursive;
        }
        
        .cart-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 40px;
            margin-bottom: 60px;
        }
        
        @media (max-width: 768px) {
            .cart-content {
                grid-template-columns: 1fr;
            }
        }
        
        .cart-items {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
        }
        
        .cart-item {
            display: flex;
            gap: 20px;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-image {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-title {
            font-size: 1.2rem;
            color: var(--dark-gray);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .cart-item-price {
            color: var(--primary-red);
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-btn:hover {
            background-color: #f5f5f5;
        }
        
        .quantity {
            padding: 0 10px;
            font-weight: 600;
        }
        
        .remove-item {
            background-color: #ffebee;
            color: var(--primary-red);
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 20px;
        }
        
        .remove-item:hover {
            background-color: #ffcdd2;
        }
        
        .cart-summary-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            height: fit-content;
        }
        
        .cart-summary-card h2 {
            color: var(--dark-gray);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .summary-row.total {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-red);
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .checkout-btn {
            background-color: var(--primary-red);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 5px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: var(--dark-red);
        }
        
        .checkout-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .cart-empty {
            text-align: center;
            padding: 60px 20px;
        }
        
        .cart-empty i {
            font-size: 5rem;
            color: var(--primary-red);
            margin-bottom: 20px;
        }
        
        .cart-empty h2 {
            color: var(--dark-gray);
            margin-bottom: 15px;
        }
        
        .cart-empty p {
            color: var(--text-gray);
            margin-bottom: 30px;
        }
        
        .continue-shopping {
            display: inline-block;
            background-color: var(--primary-red);
            color: white;
            text-decoration: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .continue-shopping:hover {
            background-color: var(--dark-red);
        }
        
        /* Стили для модальных окон */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--dark-red);
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-modal:hover {
            color: var(--primary-red);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--dark-red);
        }

        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .payment-option {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option:hover {
            border-color: var(--primary-red);
            background-color: #fff5f5;
        }

        .payment-option i {
            font-size: 2rem;
            color: var(--primary-red);
            margin-bottom: 10px;
        }

        .payment-option h3 {
            margin: 0 0 10px 0;
            color: var(--dark-gray);
        }

        .payment-option p {
            margin: 0;
            color: var(--text-gray);
        }

        .bonus-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff5f5;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .delivery-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .delivery-option {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .delivery-option:hover {
            border-color: var(--primary-red);
            background-color: #fff5f5;
        }

        .delivery-option i {
            font-size: 2rem;
            color: var(--primary-red);
        }

        .delivery-option h3 {
            margin: 0 0 5px 0;
            color: var(--dark-gray);
        }

        .delivery-option p {
            margin: 0;
            color: var(--text-gray);
            font-size: 0.9em;
        }

        .order-summary {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .order-summary p {
            margin: 5px 0;
        }
        
        /* Кнопка быстрой техподдержки */
        .support-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 999;
            transition: all 0.3s;
        }
        
        .support-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .support-button.active {
            width: 260px;
            border-radius: 30px;
            justify-content: flex-start;
            padding-left: 20px;
        }
        
        .support-text {
            display: none;
            margin-left: 10px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .support-button.active .support-text {
            display: inline-block;
        }
        
        /* Меню техподдержки */
        .support-menu {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            width: 250px;
            z-index: 998;
            display: none;
            overflow: hidden;
        }
        
        .support-menu.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .support-header {
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .support-header h3 {
            margin: 0;
            font-size: 16px;
        }
        
        .support-items {
            padding: 10px 0;
        }
        
        .support-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .support-item:hover {
            background-color: #f5f5f5;
        }
        
        .support-item i {
            width: 24px;
            color: var(--primary-red);
            margin-right: 10px;
        }
        
        .support-item span {
            font-size: 14px;
        }
        
        .support-divider {
            height: 1px;
            background-color: #eee;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- Проверка авторизации -->
    <script>
        if (!localStorage.getItem('currentUser')) {
            window.location.href = 'index.html';
        }
    </script>
    
    <!-- Шапка сайта -->
<header class="header">
    <div class="header-container">
        <div class="header-main">
            <div class="logo-section">
                <div class="logo-icon-wrapper">
                    <i class="fas fa-spa"></i>
                </div>
                <div class="logo-text">
                    <h1 class="logo-title">Цветничок у Оли</h1>
                    <p class="logo-subtitle">Красивые цветы для вашего настроения</p>
                </div>
            </div>
            
            <div class="header-contacts">
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <div class="contact-info">
                        <span class="contact-number">+375 25 530-99-49</span>
                        <span class="contact-number">+375 33 623-94-33</span>
                    </div>
                </div>
                <div class="contact-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span class="contact-address">г.п. Вороново, ул. Аэродромная, д. 25</span>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="user-section">
                    <span id="user-greeting"></span>
                    <a href="#" id="logout" class="logout-btn">Выйти</a>
                </div>
                <a href="cart.html" class="cart-button" id="open-cart">
                    <i class="fas fa-shopping-basket"></i>
                    <span class="cart-badge" id="cart-count">0</span>
                </a>
            </div>
        </div>
        
        <nav class="main-nav">
            <a href="home.html" class="nav-link active">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </a>
            <a href="catalog.html" class="nav-link">
                <i class="fas fa-th-large"></i>
                <span>Каталог</span>
            </a>
            <a href="contacts.html" class="nav-link">
                <i class="fas fa-address-book"></i>
                <span>Контакты</span>
            </a>
            <a href="account.html" class="nav-link">
                <i class="fas fa-user"></i>
                <span>Мой аккаунт</span>
            </a>
            <a href="news.html" class="nav-link">
                <i class="fas fa-newspaper"></i>
                <span>Новости</span>
            </a>
        </nav>
    </div>
</header>
    
    <!-- Контент страницы корзины -->
    <div class="cart-page">
        <div class="cart-header">
            <h1>Ваша корзина</h1>
            <p>Проверьте товары перед оформлением заказа</p>
        </div>
        
        <div class="cart-content">
            <div class="cart-items" id="cart-content">
                <!-- Содержимое корзины будет загружено через JS -->
            </div>
            
            <div class="cart-summary-card">
                <h2>Итог заказа</h2>
                <div class="summary-row">
                    <span>Товары:</span>
                    <span id="items-total">0 руб.</span>
                </div>
                <div class="summary-row">
                    <span>Доставка:</span>
                    <span id="delivery-cost">Бесплатно</span>
                </div>
                <div class="summary-row total">
                    <span>Итого:</span>
                    <span id="cart-total">0 руб.</span>
                </div>
                <button class="checkout-btn" id="checkout-btn" disabled>Оформить заказ</button>
                <p style="text-align: center; margin-top: 15px; color: var(--text-gray); font-size: 0.9rem;">
                    Нажимая кнопку, вы соглашаетесь с условиями обработки персональных данных
                </p>
            </div>
        </div>
        
        <div style="text-align: center;">
            <a href="catalog.html" class="continue-shopping">Продолжить покупки</a>
        </div>
    </div>
    
    <!-- Футер -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-column">
                <h3>Цветничок у Оли</h3>
                <p>Магазин цветов с душой. Мы создаем красивые букеты, которые дарят радость и выражают ваши чувства.</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-vk"></i></a>
                    <a href="#"><i class="fab fa-telegram"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
            
            <div class="footer-column">
                <h3>Магазин</h3>
                <ul class="footer-links">
                    <li><a href="catalog.html">Каталог букетов</a></li>
                    <li><a href="home.html#promotions">Акции и скидки</a></li>
                </ul>
            </div>
            
            <div class="footer-column">
                <h3>Помощь</h3>
                <ul class="footer-links">
                    <li><a href="#">Доставка и оплата</a></li>
                    <li><a href="#">Уход за цветами</a></li>
                    <li><a href="#">Частые вопросы</a></li>
                    <li><a href="contacts.html">Контакты</a></li>
                </ul>
            </div>
            
            <div class="footer-column">
                <h3>Контакты</h3>
                <p><i class="fas fa-map-marker-alt"></i> г.п. Вороново, ул. Аэродромная, д. 25</p>
                <p><i class="fas fa-phone"></i> +375 25 530-99-49 / +375 33 623-94-33</p>
                <p><i class="fas fa-envelope"></i> olgabalts@gmail.com / ilyabalt345ilya1@gmail.com</p>
                <p><i class="fas fa-clock"></i> Ежедневно с 10:00 до 20:00</p>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2026 Магазин цветов "Цветничок у Оли". Все права защищены.</p>
        </div>
    </footer>

    <!-- Кнопка быстрой техподдержки -->
    <div class="support-button" id="support-button">
        <i class="fas fa-headset"></i>
        <span class="support-text">Техподдержка</span>
    </div>
    
    <!-- Меню техподдержки -->
    <div class="support-menu" id="support-menu">
        <div class="support-header">
            <h3>Служба поддержки</h3>
        </div>
        <div class="support-items">
            <div class="support-item" onclick="openSupport('whatsapp')">
                <i class="fab fa-whatsapp"></i>
                <span>WhatsApp: +375 25 530-99-49</span>
            </div>
            <div class="support-divider"></div>
            <div class="support-item" onclick="openSupport('telegram')">
                <i class="fab fa-telegram"></i>
                <span>Telegram: +375 33 623-94-33</span>
            </div>
            <div class="support-divider"></div>
            <div class="support-item" onclick="openSupport('phone')">
                <i class="fas fa-phone"></i>
                <span>Позвонить</span>
            </div>
            <div class="support-divider"></div>
            <div class="support-item" onclick="openSupport('email')">
                <i class="fas fa-envelope"></i>
                <span>Написать на почту</span>
            </div>
            <div class="support-divider"></div>
            <div class="support-item" onclick="openSupport('faq')">
                <i class="fas fa-question-circle"></i>
                <span>Частые вопросы</span>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <!-- Модальное окно выбора способа оплаты -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Выберите способ оплаты</h2>
                <span class="close-modal" onclick="closePaymentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="payment-options">
                    <div class="payment-option" onclick="selectPayment('money')">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3>Деньгами</h3>
                        <p>Оплата наличными или картой при получении</p>
                    </div>
                    <div class="payment-option" onclick="selectPayment('bonuses')">
                        <i class="fas fa-gift"></i>
                        <h3>Бонусами</h3>
                        <p>Оплата бонусными баллами</p>
                        <div class="bonus-info">
                            Доступно: <span id="available-bonuses">0</span> бонусов<br>
                            1 бонус = 0.1 рубля
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно недостатка бонусов -->
    <div id="insufficient-bonuses-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Недостаточно бонусов</h2>
            </div>
            <div class="modal-body">
                <p>У вас недостаточно бонусов для полной оплаты заказа.</p>
                <p>Хотите оплатить часть суммы бонусами?</p>
                <div class="order-summary">
                    <p>Сумма заказа: <span id="order-total-sum">0</span> руб.</p>
                    <p>Ваши бонусы: <span id="user-bonuses">0</span> (эквивалент <span id="bonus-equivalent">0</span> руб.)</p>
                    <p>Недостающая сумма: <span id="remaining-amount">0</span> руб.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cancelBonusPayment()">Нет, оплатить деньгами</button>
                <button class="btn btn-primary" onclick="partialBonusPayment()">Да, оплатить часть бонусами</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно выбора доставки -->
    <div id="delivery-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Выберите способ получения</h2>
            </div>
            <div class="modal-body">
                <p id="delivery-message">Как вы хотите получить заказ?</p>
                <div class="delivery-options">
                    <div class="delivery-option" onclick="selectDelivery('pickup')">
                        <i class="fas fa-store"></i>
                        <div>
                            <h3>Самовывоз</h3>
                            <p>г.п. Вороново, ул. Аэродромная, д. 25</p>
                        </div>
                    </div>
                    <div class="delivery-option" onclick="selectDelivery('delivery')">
                        <i class="fas fa-truck"></i>
                        <div>
                            <h3>Доставка</h3>
                            <p>Курьерская доставка по адресу</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для указания даты самовывоза -->
    <div id="pickup-date-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Укажите дату самовывоза</h2>
            </div>
            <div class="modal-body">
                <p>Пожалуйста, укажите дату, когда вы планируете забрать заказ:</p>
                <input type="date" id="pickup-date" min="" style="width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px;">
                <p style="font-size: 0.9em; color: #666;">Обратите внимание: заказ будет готов к выдаче через 2 часа после оформления.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePickupDateModal()">Отмена</button>
                <button class="btn btn-primary" onclick="confirmPickupDate()">Подтвердить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для ввода адреса доставки -->
    <div id="address-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Укажите адрес доставки</h2>
            </div>
            <div class="modal-body">
                <p>Пожалуйста, укажите адрес доставки:</p>
                <textarea id="delivery-address" rows="4" placeholder="Введите полный адрес доставки..." style="width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                <p style="font-size: 0.9em; color: #666;">Или добавьте адрес в настройках вашего аккаунта</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cancelAddress()">Отмена</button>
                <button class="btn btn-primary" onclick="confirmAddress()">Подтвердить адрес</button>
            </div>
        </div>
    </div>

    <script>
        // Данные пользователя
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        
        // Корзина
        let cart = JSON.parse(localStorage.getItem('flowerCart')) || [];
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            // Отображаем информацию о пользователе
            if (currentUser) {
                document.getElementById('user-greeting').textContent = `Привет, ${currentUser.name}!`;
            }
            
            // Обновляем корзину
            updateCartCount();
            renderCart();
            
            // Выход из аккаунта
            document.getElementById('logout').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
            
            // Оформление заказа
            document.getElementById('checkout-btn').addEventListener('click', function() {
                if (cart.length > 0) {
                    // Сохраняем данные заказа для использования в модальных окнах
                    window.orderData = {
                        items: [...cart],
                        total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                    };
                    
                    // Показываем модальное окно выбора способа оплаты
                    showPaymentModal();
                }
            });
            
            // Инициализация даты для календаря
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pickup-date').min = today;
            
            // Тестовые данные для отладки
            setupTestBonuses();
            
            // Инициализация кнопки техподдержки
            initSupportButton();
        });
        
        // Инициализация кнопки техподдержки
        function initSupportButton() {
            const supportButton = document.getElementById('support-button');
            const supportMenu = document.getElementById('support-menu');
            
            // Открытие/закрытие меню техподдержки
            supportButton.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
                supportMenu.classList.toggle('active');
            });
            
            // Закрытие меню при клике вне его
            document.addEventListener('click', function(e) {
                if (!supportMenu.contains(e.target) && !supportButton.contains(e.target)) {
                    supportButton.classList.remove('active');
                    supportMenu.classList.remove('active');
                }
            });
        }
        
        // Открытие техподдержки
        function openSupport(type) {
            let link = '';
            
            switch(type) {
                case 'whatsapp':
                    link = 'https://wa.me/375255309949?text=Здравствуйте!%20У%20меня%20вопрос%20по%20заказу%20в%20магазине%20"Цветничок%20у%20Оли"';
                    window.open(link, '_blank');
                    break;
                    
                case 'telegram':
                    link = 'https://t.me/+375336239433';
                    window.open(link, '_blank');
                    break;
                    
                case 'phone':
                    link = 'tel:+375255309949';
                    window.location.href = link;
                    break;
                    
                case 'email':
                    link = 'mailto:olgabalts@gmail.com?subject=Вопрос%20по%20заказу&body=Здравствуйте!%20У%20меня%20вопрос%20по%20заказу...';
                    window.location.href = link;
                    break;
                    
                case 'faq':
                    alert('Раздел "Частые вопросы" скоро появится на сайте!');
                    break;
            }
            
            // Закрываем меню после выбора
            document.getElementById('support-button').classList.remove('active');
            document.getElementById('support-menu').classList.remove('active');
        }
        
        // Функция для создания тестовых данных бонусов (если их нет)
        function setupTestBonuses() {
            const users = JSON.parse(localStorage.getItem('flowerShopUsers')) || [];
            
            if (currentUser && users.length > 0) {
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                
                if (userIndex !== -1) {
                    // Если у пользователя нет бонусов, добавляем тестовые 3000
                    if (users[userIndex].totalBonuses === undefined || users[userIndex].totalBonuses === null) {
                        users[userIndex].totalBonuses = 3000;
                        localStorage.setItem('flowerShopUsers', JSON.stringify(users));
                        console.log("Добавлены тестовые бонусы: 3000");
                    }
                    
                    // Также проверяем и добавляем в другие возможные поля
                    if (users[userIndex].bonuses === undefined) {
                        users[userIndex].bonuses = 3000;
                    }
                    
                    localStorage.setItem('flowerShopUsers', JSON.stringify(users));
                }
            }
        }
        
        // Обновление счетчика корзины
        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
        }
        
        // Рендер корзины
        function renderCart() {
            const cartContent = document.getElementById('cart-content');
            const cartTotal = document.getElementById('cart-total');
            const itemsTotal = document.getElementById('items-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (cart.length === 0) {
                cartContent.innerHTML = `
                    <div class="cart-empty">
                        <i class="fas fa-shopping-basket"></i>
                        <h2>Корзина пуста</h2>
                        <p>Добавьте товары из каталога</p>
                        <a href="catalog.html" class="continue-shopping">Перейти в каталог</a>
                    </div>
                `;
                cartTotal.textContent = '0 руб.';
                itemsTotal.textContent = '0 руб.';
                checkoutBtn.disabled = true;
                return;
            }
            
            let cartHTML = '';
            let totalPrice = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                totalPrice += itemTotal;
                
                cartHTML += `
                    <div class="cart-item">
                        <div class="cart-item-image">
                            <img src="${item.image}" alt="${item.name}">
                        </div>
                        <div class="cart-item-details">
                            <div class="cart-item-title">${item.name}</div>
                            <div class="cart-item-price">${item.price} руб. × ${item.quantity} = ${itemTotal} руб.</div>
                            <div class="cart-item-actions">
                                <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, -1)">-</button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateCartQuantity(${item.id}, 1)">+</button>
                                <button class="remove-item" onclick="removeFromCart(${item.id})">Удалить</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            cartContent.innerHTML = cartHTML;
            cartTotal.textContent = `${totalPrice} руб.`;
            itemsTotal.textContent = `${totalPrice} руб.`;
            checkoutBtn.disabled = false;
        }
        
        // Обновление количества товара в корзине
        function updateCartQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            
            if (item) {
                item.quantity += change;
                
                if (item.quantity <= 0) {
                    cart = cart.filter(item => item.id !== productId);
                }
                
                localStorage.setItem('flowerCart', JSON.stringify(cart));
                updateCartCount();
                renderCart();
            }
        }
        
        // Удаление товара из корзины
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            localStorage.setItem('flowerCart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
        }
        
        // Получить бонусы пользователя - УПРОЩЕННАЯ ВЕРСИЯ
        function getUserBonuses() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return 0;
            
            const users = JSON.parse(localStorage.getItem('flowerShopUsers')) || [];
            const userData = users.find(u => u.email === currentUser.email);
            
            if (!userData) return 0;
            
            // Пробуем найти бонусы в любом поле
            const bonusFields = ['totalBonuses', 'bonuses', 'bonusPoints', 'bonus', 'points'];
            
            for (let field of bonusFields) {
                if (userData[field] !== undefined && userData[field] !== null) {
                    console.log(`Нашли бонусы в поле "${field}":`, userData[field]);
                    return parseInt(userData[field]) || 0;
                }
            }
            
            // Если ничего не нашли, возвращаем 3000 для тестирования
            console.log("Бонусы не найдены, используем тестовые 3000");
            return 3000;
        }
        
        // Проверить адрес пользователя
        function getUserAddress() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return null;
            
            const users = JSON.parse(localStorage.getItem('flowerShopUsers')) || [];
            const userData = users.find(u => u.email === currentUser.email);
            
            if (!userData) return null;
            
            return userData.address || null;
        }
        
        // Показать модальное окно выбора оплаты
        function showPaymentModal() {
            // Получаем бонусы пользователя
            const availableBonuses = getUserBonuses();
            
            console.log("Показываем бонусы в модальном окне:", availableBonuses);
            
            // Обновляем информацию о бонусах (ИЗМЕНЕНИЕ: 1 бонус = 0.1 рубля)
            document.getElementById('available-bonuses').textContent = availableBonuses;
            
            const paymentModal = document.getElementById('payment-modal');
            paymentModal.style.display = 'flex';
        }
        
        // Закрыть модальное окно оплаты
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
        }
        
        // Выбор способа оплаты
        function selectPayment(method) {
            closePaymentModal();
            
            if (method === 'money') {
                // Оплата деньгами - показываем выбор доставки
                window.orderData.paymentMethod = 'money';
                showDeliveryModal();
            } else if (method === 'bonuses') {
                // Оплата бонусами - проверяем хватает ли
                window.orderData.paymentMethod = 'bonuses';
                checkBonusAvailability();
            }
        }
        
        // Проверить доступность бонусов (ИЗМЕНЕНИЕ: 1 бонус = 0.1 рубля)
        function checkBonusAvailability() {
            const availableBonuses = getUserBonuses();
            const bonusValue = availableBonuses * 0.1; // ИЗМЕНЕНИЕ: 1 бонус = 0.1 рубля
            const orderTotal = window.orderData.total;
            
            console.log("Проверка бонусов:", {
                availableBonuses,
                bonusValue,
                orderTotal,
                хватает: bonusValue >= orderTotal
            });
            
            if (bonusValue >= orderTotal) {
                // Хватает бонусов - показываем выбор доставки
                showDeliveryModal();
            } else {
                // Не хватает бонусов - показываем окно с выбором
                showInsufficientBonusesModal(availableBonuses, bonusValue, orderTotal);
            }
        }
        
        // Показать окно недостатка бонусов (ИЗМЕНЕНИЕ: 1 бонус = 0.1 рубля)
        function showInsufficientBonusesModal(availableBonuses, bonusValue, orderTotal) {
            document.getElementById('user-bonuses').textContent = availableBonuses;
            document.getElementById('bonus-equivalent').textContent = bonusValue.toFixed(2);
            document.getElementById('order-total-sum').textContent = orderTotal;
            document.getElementById('remaining-amount').textContent = (orderTotal - bonusValue).toFixed(2);
            
            document.getElementById('insufficient-bonuses-modal').style.display = 'flex';
        }
        
        // Отмена оплаты бонусами
        function cancelBonusPayment() {
            document.getElementById('insufficient-bonuses-modal').style.display = 'none';
            // Переключаем на оплату деньгами
            window.orderData.paymentMethod = 'money';
            showDeliveryModal();
        }
        
        // Частичная оплата бонусами
        function partialBonusPayment() {
            document.getElementById('insufficient-bonuses-modal').style.display = 'none';
            // Сохраняем информацию о частичной оплате бонусами
            window.orderData.paymentMethod = 'partial_bonuses';
            showDeliveryModal();
        }
        
        // Показать окно выбора доставки
        function showDeliveryModal() {
            // Получаем адрес пользователя
            const userAddress = getUserAddress();
            
            // Обновляем сообщение в зависимости от наличия адреса
            const deliveryMessage = document.getElementById('delivery-message');
            if (userAddress) {
                deliveryMessage.textContent = `У вас указан адрес: ${userAddress}. Хотите использовать его для доставки или забрать самовывозом?`;
            } else {
                deliveryMessage.textContent = 'Как вы хотите получить заказ?';
            }
            
            document.getElementById('delivery-modal').style.display = 'flex';
        }
        
        // Выбор способа доставки
        function selectDelivery(method) {
            document.getElementById('delivery-modal').style.display = 'none';
            
            if (method === 'pickup') {
                // Самовывоз - запрашиваем дату
                window.orderData.deliveryMethod = 'pickup';
                showPickupDateModal();
            } else if (method === 'delivery') {
                // Доставка - проверяем есть ли адрес
                window.orderData.deliveryMethod = 'delivery';
                const userAddress = getUserAddress();
                
                if (userAddress) {
                    // Используем сохраненный адрес
                    window.orderData.deliveryAddress = userAddress;
                    sendOrderToEmail();
                } else {
                    // Запрашиваем новый адрес
                    showAddressModal();
                }
            }
        }
        
        // Показать окно выбора даты самовывоза
        function showPickupDateModal() {
            // Устанавливаем дату по умолчанию (завтра)
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 1);
            document.getElementById('pickup-date').value = defaultDate.toISOString().split('T')[0];
            
            document.getElementById('pickup-date-modal').style.display = 'flex';
        }
        
        // Закрыть окно даты самовывоза
        function closePickupDateModal() {
            document.getElementById('pickup-date-modal').style.display = 'none';
            // Возвращаемся к выбору доставки
            setTimeout(() => showDeliveryModal(), 300);
        }
        
        // Подтвердить дату самовывоза
        function confirmPickupDate() {
            const pickupDate = document.getElementById('pickup-date').value;
            if (!pickupDate) {
                alert('Пожалуйста, выберите дату');
                return;
            }
            
            window.orderData.pickupDate = pickupDate;
            window.orderData.deliveryAddress = 'Самовывоз';
            
            closePickupDateModal();
            sendOrderToEmail();
        }
        
        // Показать окно ввода адреса
        function showAddressModal() {
            // Если у пользователя есть адрес, показываем его в поле ввода
            const userAddress = getUserAddress();
            const addressInput = document.getElementById('delivery-address');
            
            if (userAddress) {
                addressInput.value = userAddress;
            } else {
                addressInput.value = '';
            }
            
            document.getElementById('address-modal').style.display = 'flex';
        }
        
        // Отмена ввода адреса
        function cancelAddress() {
            document.getElementById('address-modal').style.display = 'none';
            // Возвращаемся к выбору доставки
            setTimeout(() => showDeliveryModal(), 300);
        }
        
        // Подтвердить адрес
        function confirmAddress() {
            const address = document.getElementById('delivery-address').value.trim();
            if (!address) {
                alert('Пожалуйста, введите адрес доставки');
                return;
            }
            
            window.orderData.deliveryAddress = address;
            
            // Сохраняем адрес в аккаунте пользователя
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const users = JSON.parse(localStorage.getItem('flowerShopUsers')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            
            if (userIndex !== -1) {
                users[userIndex].address = address;
                localStorage.setItem('flowerShopUsers', JSON.stringify(users));
            }
            
            document.getElementById('address-modal').style.display = 'none';
            sendOrderToEmail();
        }
        
        // Отправить заказ на почту (ИЗМЕНЕНИЕ: 1 бонус = 0.1 рубля)
        function sendOrderToEmail() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // Подготовка данных для письма
            const order = window.orderData;
            const usedBonuses = calculateUsedBonuses(order);
            const bonusValue = usedBonuses * 0.1; // ИЗМЕНЕНИЕ: 1 бонус = 0.1 рубля
            
            const orderDetails = `
ИНФОРМАЦИЯ О ЗАКАЗЕ:

ПОЛЬЗОВАТЕЛЬ:
- Имя: ${currentUser.name}
- Email: ${currentUser.email}
- Телефон: ${currentUser.phone || 'Не указан'}

ТОВАРЫ:
${order.items.map(item => `- ${item.name} (${item.quantity} шт.) - ${item.price} руб./шт. = ${item.price * item.quantity} руб.`).join('\n')}

СУММА ЗАКАЗА:
- Общая сумма: ${order.total} руб.
- Способ оплаты: ${getPaymentMethodText(order.paymentMethod)}
- Использовано бонусов: ${usedBonuses} (${bonusValue} руб.)

ДОСТАВКА:
- Способ получения: ${order.deliveryMethod === 'pickup' ? 'Самовывоз' : 'Доставка'}
${order.deliveryMethod === 'pickup' ? `- Дата самовывоза: ${order.pickupDate}` : `- Адрес доставки: ${order.deliveryAddress}`}
${order.deliveryMethod === 'pickup' ? 'ВАЖНО: САМОВЫВОС - НАПИШИТЕ ДАТУ КОГДА ЗАБЕРЁТЕ ЗАКАЗ' : ''}

Дата оформления заказа: ${new Date().toLocaleString('ru-RU')}
            `;
            
            // Формируем ссылку для отправки на почту
            const email = 'ilyabalt345ilya1@gmail.com';
            const subject = `Новый заказ от ${currentUser.name}`;
            const body = encodeURIComponent(orderDetails);
            
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${body}`;
            
            // Открываем почтовый клиент
            window.location.href = mailtoLink;
            
            // После отправки очищаем корзину
            setTimeout(() => {
                completeOrder();
            }, 1000);
        }
        
        // Получить текст метода оплаты
        function getPaymentMethodText(method) {
            switch(method) {
                case 'money': return 'Деньгами (полная оплата)';
                case 'bonuses': return 'Полностью бонусами';
                case 'partial_bonuses': return 'Частично бонусами + деньгами';
                default: return 'Не указан';
            }
        }
        
        // Рассчитать использованные бонусы (ИЗМЕНЕНИЕ: 1 бонус = 0.1 рубля)
        function calculateUsedBonuses(order) {
            const availableBonuses = getUserBonuses();
            
            if (order.paymentMethod === 'bonuses') {
                // Полная оплата бонусами
                return Math.min(availableBonuses, Math.ceil(order.total / 0.1));
            } else if (order.paymentMethod === 'partial_bonuses') {
                // Частичная оплата бонусами (используем все доступные)
                return availableBonuses;
            }
            
            return 0;
        }
        
        // Завершить заказ
        function completeOrder() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const users = JSON.parse(localStorage.getItem('flowerShopUsers')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            
            if (userIndex !== -1) {
                // Вычитаем использованные бонусы
                const usedBonuses = calculateUsedBonuses(window.orderData);
                if (usedBonuses > 0) {
                    users[userIndex].totalBonuses = Math.max(0, (users[userIndex].totalBonuses || 0) - usedBonuses);
                    
                    // Добавляем в историю списания
                    if (!users[userIndex].bonusHistory) {
                        users[userIndex].bonusHistory = [];
                    }
                    users[userIndex].bonusHistory.push({
                        date: new Date().toISOString(),
                        type: 'spent',
                        amount: usedBonuses,
                        description: `Списание за заказ #${Date.now().toString().slice(-6)}`
                    });
                }
                
                // Сохраняем заказ
                const order = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    items: window.orderData.items,
                    total: window.orderData.total,
                    paymentMethod: window.orderData.paymentMethod,
                    deliveryMethod: window.orderData.deliveryMethod,
                    deliveryAddress: window.orderData.deliveryAddress,
                    pickupDate: window.orderData.pickupDate,
                    usedBonuses: usedBonuses,
                    status: 'новый'
                };
                
                if (!users[userIndex].orders) {
                    users[userIndex].orders = [];
                }
                users[userIndex].orders.push(order);
                
                localStorage.setItem('flowerShopUsers', JSON.stringify(users));
            }
            
            // Очищаем корзину
            cart = [];
            localStorage.setItem('flowerCart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
            
            alert('Заказ успешно оформлен! Проверьте вашу почту для подтверждения.');
        }
        
        // Закрытие модальных окон при клике вне их
        document.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>